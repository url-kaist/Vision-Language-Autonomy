<launch>
    <arg name="quiet" default="false"/>
    <arg name="real_world" default="true"/>

    <!-- Topic name arguments (only used if real_world=true) -->
    <arg name="sensor_scan_topic" default="/velodyne_points"/>
    <arg name="registered_scan_topic" default="/velodyne_points"/>
    <arg name="camera_image_topic" default="/camera/image/compressed"/>
    <arg name="odom_topic" default="/odom"/>
    <arg name="robot_pose_topic" default="/robot_pose"/>
    <arg name="navigation_goal_topic" default="/move_base_simple/goal"/>
    <arg name="cmd_vel_topic" default="/UGV2/jackal_velocity_controller/cmd_vel"/>
    <arg name="robot_type" default="jackal"/>

    <!-- Real-world topic remapping (only if real_world=true) -->
    <group if="$(arg real_world)">
        <remap from="/sensor_scan" to="$(arg sensor_scan_topic)"/>
        <remap from="/registered_scan" to="$(arg registered_scan_topic)"/>
        <remap from="/camera/image" to="$(arg camera_image_topic)"/>
        <remap from="/state_estimation" to="$(arg odom_topic)"/>
        <remap from="/state_estimation_at_scan" to="/state_estimation_at_scan"/>
        <remap from="/state_estimation_pose_at_scan" to="$(arg robot_pose_topic)"/>
        <remap from="/way_point_with_heading" to="$(arg navigation_goal_topic)"/>
        <remap from="/cmd_vel" to="$(arg cmd_vel_topic)"/>
        <remap from="~cmd_vel"  to="$(arg cmd_vel_topic)"/>
        <remap from="/cmd_vel"  to="$(arg cmd_vel_topic)"/>
        
        <param name="deployment/environment" value="real_world"/>
        <param name="deployment/robot_type" value="$(arg robot_type)"/>

        <!-- OctoMap 서버: 해상도 및 센서 최대거리 -->
        <node pkg="octomap_server" type="octomap_server_node" name="octomap_server" output="screen">
            <param name="resolution"          value="0.1"/>
            <param name="sensor_model/max_range" value="5.0"/>
            <param name="frame_id"            type="string" value="map"/>
            <param name="base_frame_id"       type="string" value="baselink"/>
            <param name="occupancy/meanUpdate" value="false"/>
            <param name="publish_free_space" value="true"/>  
            <param name="publish_occupied_nodes" value="true"/>
            <param name="minimum_occupancy" value="80"/>   
            <!-- 로봇 높이를 고려해, 너무 낮은 z 축 지점 무시 -->
            <param name="minimum_z"         value="0.05"/>  
            <param name="maximum_z"         value="1.2"/>  
            <!-- 경사 허용 범위 조정(지면 외부 역노이즈 억제) -->
            <param name="max_slope_ugv"     value="0.3"/>   
            <remap from="cloud_in" to="/sensor_scan"/>
        </node>

        <!-- 3D→2D 맵 변환: 지면 & 슬로프 파라미터 -->
        <node pkg="mapconversion" type="map_conversion_oct_node" name="map_conversion" output="screen">
            <remap from="octomap" to="octomap_binary"/>
            <!-- 바닥 노이즈 제거: 10cm 이하 무시 -->
            <param name="minimum_z"             value="0.2"/>
            <!-- 최소 관측 횟수: 3~5회 -->
            <param name="minimum_occupancy"     value="50"/>
            <param name="map_frame"             value="map"/>
            <!-- UGV 주행 불가 경사: 0.3rad (≈17°) 이상 -->
            <param name="max_slope_ugv"         value="0.1"/>
            <!-- 경사 산출 윈도우 크기: 3 -->
            <param name="slope_estimation_size" value="1.5"/>
        </node>
    </group>
</launch>